<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Hunter Pro - Professional Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }

        /* App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: #0d1117;
        }

        /* Navigation */
        nav {
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%);
            border-bottom: 1px solid #30363d;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #f78166 0%, #ea6045 50%, #d73a49 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .live-indicator {
            background: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-btn {
            background: rgba(110, 118, 129, 0.1);
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(110, 118, 129, 0.2);
            border-color: #6e7681;
            transform: translateY(-1px);
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
            border-color: #2ea043;
        }

        .nav-btn.primary:hover {
            background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #161b22 0%, #21262d 100%);
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .sidebar-header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid #30363d;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #8b949e;
        }

        .sidebar-section {
            padding: 16px 0;
            border-bottom: 1px solid #30363d;
        }

        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #c9d1d9;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(110, 118, 129, 0.1);
            color: #f0f6fc;
            border-left-color: #6e7681;
        }

        .nav-item.active {
            background: rgba(56, 139, 253, 0.1);
            color: #58a6ff;
            border-left-color: #58a6ff;
        }

        .nav-item .icon {
            width: 16px;
            margin-right: 12px;
            font-size: 16px;
        }

        .nav-item .badge {
            margin-left: auto;
            background: #238636;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .nav-item .status {
            margin-left: auto;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #6e7681;
            color: white;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .content-header {
            background: rgba(22, 27, 34, 0.8);
            border-bottom: 1px solid #21262d;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .page-info h1 {
            font-size: 28px;
            font-weight: 700;
            color: #f0f6fc;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #f0f6fc 0%, #8b949e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-info p {
            color: #8b949e;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 24px 32px;
            background: rgba(13, 17, 23, 0.8);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.8) 0%, rgba(33, 38, 45, 0.8) 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #6e7681;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #f0f6fc;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #8b949e;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            color: #56d364;
        }

        /* Content Body */
        .content-body {
            flex: 1;
            padding: 24px 32px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            min-height: 0;
        }

        /* Panel Styles */
        .panel {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.8) 0%, rgba(33, 38, 45, 0.8) 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: #6e7681;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            background: rgba(33, 38, 45, 0.8);
            padding: 20px 24px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .panel-actions {
            display: flex;
            gap: 12px;
        }

        .panel-body {
            padding: 24px;
        }

        /* File Upload Area */
        .upload-area {
            border: 2px dashed #30363d;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(110, 118, 129, 0.05);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .upload-text {
            color: #8b949e;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 12px;
            color: #6e7681;
        }

        /* File Info */
        .file-info {
            background: rgba(56, 139, 253, 0.1);
            border: 1px solid #388bfd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-info-title {
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 8px;
        }

        .file-info-details {
            color: #c9d1d9;
            font-size: 14px;
        }

        /* Analysis Button */
        .analysis-section {
            margin-top: 24px;
        }

        .analysis-btn {
            width: 100%;
            background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analysis-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2ea043 0%, #238636 100%);
            transform: translateY(-2px);
        }

        .analysis-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Table */
        .results-table {
            display: none;
            margin-top: 24px;
            grid-column: 1 / -1;
        }

        .results-table.show {
            display: block;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: rgba(33, 38, 45, 0.8);
            border-bottom: 1px solid #30363d;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(22, 27, 34, 0.8);
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        .data-table th {
            background: rgba(33, 38, 45, 0.8);
            color: #f0f6fc;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tbody tr:hover {
            background: rgba(110, 118, 129, 0.1);
        }

        .data-table .symbol-cell {
            font-weight: 600;
            color: #58a6ff;
        }

        .data-table .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pass {
            background: #238636;
            color: white;
        }

        .status-fail {
            background: #da3633;
            color: white;
        }

        .positive {
            color: #56d364;
        }

        .negative {
            color: #f85149;
        }

        .neutral {
            color: #c9d1d9;
        }

        /* Log Panel */
        .log-panel {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #21262d;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-timestamp {
            color: #6e7681;
            font-weight: 600;
            min-width: 50px;
        }

        .log-info {
            color: #58a6ff;
        }

        .log-success {
            color: #56d364;
        }

        .log-warning {
            color: #e3b341;
        }

        .log-error {
            color: #f85149;
        }

        /* Filter Bar */
        .filter-bar {
            display: none;
            padding: 16px 24px;
            background: rgba(33, 38, 45, 0.8);
            border-bottom: 1px solid #30363d;
            gap: 16px;
            align-items: center;
        }

        .filter-bar.show {
            display: flex;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: #8b949e;
            font-weight: 500;
        }

        .filter-select {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Minervini Criteria */
        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(110, 118, 129, 0.1);
            border-radius: 6px;
            border-left: 3px solid #6e7681;
        }

        .criteria-item.required {
            border-left-color: #f85149;
        }

        .criteria-text {
            color: #c9d1d9;
            font-size: 14px;
        }

        .criteria-status {
            font-size: 11px;
            font-weight: 600;
            color: #f85149;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-body {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            nav {
                padding: 12px 16px;
            }
            
            .content-header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="nav-brand">
            <div class="logo">üìà Stock Hunter Pro</div>
            <div class="live-indicator" id="liveIndicator">‚óè LIVE DATA</div>
        </div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="importCSV()">üìÅ Import CSV</button>
            <button class="nav-btn" id="exportBtn" onclick="exportResults()" style="display: none;">üíæ Export Results</button>
            <button class="nav-btn primary" id="runAnalysisBtn" onclick="startAnalysis()" disabled>üöÄ Run Analysis</button>
        </div>
    </nav>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Enhanced Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Analysis Hub</div>
                <div class="sidebar-subtitle">Professional Stock Analysis Platform</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Core Analysis Tools</div>
                <div class="nav-item active" data-screen="trend-template">
                    <span class="icon">üéØ</span>
                    Trend Template
                </div>
                <div class="nav-item" data-screen="watch-list">
                    <span class="icon">‚≠ê</span>
                    Watch List
                    <span class="badge" id="watchListCount">0</span>
                </div>
                <div class="nav-item" data-screen="portfolio-analysis">
                    <span class="icon">üìä</span>
                    Portfolio Analysis
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="stock-screener">
                    <span class="icon">üîç</span>
                    Stock Screener
                    <span class="status">Soon</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Market Intelligence</div>
                <div class="nav-item" data-screen="market-overview">
                    <span class="icon">üìà</span>
                    Market Overview
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="sector-analysis">
                    <span class="icon">üè¢</span>
                    Sector Analysis
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="economic-calendar">
                    <span class="icon">üìÖ</span>
                    Economic Calendar
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="news-alerts">
                    <span class="icon">üì∞</span>
                    News & Alerts
                    <span class="status">Soon</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Advanced Tools</div>
                <div class="nav-item" data-screen="backtesting">
                    <span class="icon">‚ö°</span>
                    Backtesting
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="ai-insights">
                    <span class="icon">ü§ñ</span>
                    AI Insights
                    <span class="status">Soon</span>
                </div>
                <div class="nav-item" data-screen="settings">
                    <span class="icon">‚öôÔ∏è</span>
                    Settings
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Minervini Criteria</div>
                <div style="padding: 0 20px;">
                    <div style="font-weight: 600; color: #f0f6fc; margin-bottom: 12px;">8-Point Trend Template</div>
                    <div class="criteria-list">
                        <div class="criteria-item required">
                            <span class="criteria-text">1. Price > 50MA & 200MA</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">2. 150MA > 200MA</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">3. 200MA trending up</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">4. 50MA > other MAs</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">5. Price > 30% above 52W low</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">6. Within 25% of 52W high</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">7. Within 25% of 52W high</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                        <div class="criteria-item required">
                            <span class="criteria-text">8. RS Rating ‚â• 70</span>
                            <span class="criteria-status">‚úì REQ</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Content Header -->
            <div class="content-header">
                <div class="page-info">
                    <h1 id="pageTitle">Trend Template Analysis</h1>
                    <p id="pageDescription">Systematic stock selection using Minervini's proven 8-criteria framework</p>
                </div>
                <div class="header-actions">
                    <button class="nav-btn" onclick="testBackendConnection()">üîç Test Backend</button>
                    <button class="nav-btn" id="loadSampleBtn">üß™ Load Sample</button>
                    <button class="nav-btn" onclick="forceDisplayResults()">üîß Force Table</button>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Total Analyzed</div>
                    <div class="stat-change" id="statTotalChange">Ready to analyze</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPassed">0</div>
                    <div class="stat-label">Passed Criteria</div>
                    <div class="stat-change" id="statPassedChange">Waiting for data</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-change" id="statRateChange">No analysis yet</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statWatched">0</div>
                    <div class="stat-label">Watch Listed</div>
                    <div class="stat-change" id="statWatchedChange">Add your first stock</div>
                </div>
            </div>

            <!-- Content Body -->
            <div class="content-body">
                <!-- Data Configuration Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">Data Source Configuration</div>
                        <div class="panel-actions">
                            <button class="nav-btn" onclick="clearData()">üóëÔ∏è Clear</button>
                            <button class="nav-btn" onclick="showManualEntry()">‚úèÔ∏è Manual Entry</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- File Info Display -->
                        <div class="file-info" id="fileInfo">
                            <div class="file-info-title" id="fileInfoTitle">üìã File Loaded</div>
                            <div class="file-info-details" id="fileInfoDetails"></div>
                        </div>

                        <!-- Upload Area -->
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üìä</div>
                            <div class="upload-text">Drop your stock list here or click to browse</div>
                            <div class="upload-hint">Supports CSV, Excel, TSV files ‚Ä¢ Maximum 50MB ‚Ä¢ No limit on stock count (auto-batched)</div>
                        </div>

                        <!-- Analysis Section -->
                        <div class="analysis-section">
                            <button class="analysis-btn" id="startAnalysisBtn" onclick="startAnalysis()" disabled>
                                <span>üöÄ</span> Start Analysis
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Log Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">System Log</div>
                        <div class="panel-actions">
                            <button class="nav-btn" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="log-panel" id="logPanel">
                            <div class="log-entry">
                                <span class="log-timestamp">[SYSTEM]</span>
                                <span class="log-info">üöÄ Stock Hunter Pro v2.0 - Enhanced System Ready</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">[INFO]</span>
                                <span class="log-info">üì° Load your stock list to begin professional analysis</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">[INFO]</span>
                                <span class="log-info">‚ö° System optimized for parallel processing - 5x faster!</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">[INFO]</span>
                                <span class="log-info">üéØ Auto-batching enabled - supports unlimited stock counts</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar" id="filterBar">
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                            <option value="all">All Stocks</option>
                            <option value="passed">Passed Only</option>
                            <option value="failed">Failed Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">RS Rating:</label>
                        <select class="filter-select" id="rsFilter" onchange="applyFilters()">
                            <option value="all">All Ratings</option>
                            <option value="high">‚â• 80 (High)</option>
                            <option value="good">‚â• 70 (Good)</option>
                            <option value="average">50-69 (Average)</option>
                            <option value="low">< 50 (Low)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By:</label>
                        <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                            <option value="rs_desc">RS Rating (High to Low)</option>
                            <option value="rs_asc">RS Rating (Low to High)</option>
                            <option value="symbol_asc">Symbol (A to Z)</option>
                            <option value="price_desc">Price (High to Low)</option>
                            <option value="volume_desc">Volume (High to Low)</option>
                        </select>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="results-table" id="resultsTable">
                    <div class="table-header">
                        <div class="table-title" id="tableTitle">Analysis Results</div>
                        <div class="table-actions">
                            <button class="nav-btn" onclick="exportResults()">üíæ Export CSV</button>
                            <button class="nav-btn" onclick="addAllPassedToWatch()">‚≠ê Add All Passed</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Status</th>
                                    <th>Price</th>
                                    <th>50MA</th>
                                    <th>150MA</th>
                                    <th>200MA</th>
                                    <th>52W Low</th>
                                    <th>52W High</th>
                                    <th>From Low %</th>
                                    <th>From High %</th>
                                    <th>RS Rating</th>
                                    <th>200MA Trend</th>
                                    <th>Fail Reason</th>
                                    <th>Watch</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5000/api';
        const MAX_SYMBOLS_PER_BATCH = 1000; // Will be used for auto-batching

        // Global variables
        let stockData = [];
        let analysisResults = [];
        let watchList = [];
        let isAnalyzing = false;
        let currentScreen = 'trend-template';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('üöÄ Initializing Stock Hunter Pro v2.0...');
            
            // Load watch list from localStorage
            loadWatchListFromStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize UI
            updateUI();
            
            // Add debug button
            setTimeout(addDebugButton, 500);
            
            // Test backend connection
            setTimeout(testBackendConnection, 1000);
            
            addLogEntry('success', '‚úÖ Stock Hunter Pro v2.0 initialized successfully');
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item[data-screen]').forEach(item => {
                item.addEventListener('click', function() {
                    const screenName = this.getAttribute('data-screen');
                    switchScreen(screenName);
                });
            });

            // File upload
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.xlsx,.xls,.tsv';
                input.onchange = handleFileSelect;
                input.click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // Load sample data button
            const loadSampleBtn = document.getElementById('loadSampleBtn');
            if (loadSampleBtn) {
                loadSampleBtn.addEventListener('click', loadSampleData);
            }
        }

        function switchScreen(screenName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');

            // Update content
            currentScreen = screenName;
            const pageTitle = document.getElementById('pageTitle');
            const pageDescription = document.getElementById('pageDescription');

            switch(screenName) {
                case 'trend-template':
                    pageTitle.textContent = 'Trend Template Analysis';
                    pageDescription.textContent = 'Systematic stock selection using Minervini\'s proven 8-criteria framework';
                    break;
                case 'watch-list':
                    pageTitle.textContent = 'Watch List Management';
                    pageDescription.textContent = 'Monitor and track your selected high-potential stocks';
                    break;
                default:
                    pageTitle.textContent = 'Coming Soon';
                    pageDescription.textContent = 'This feature is under development and will be available soon';
            }
        }

        // üî¥ FIXED: normalizeSymbol function - no more replacing dots!
        function normalizeSymbol(symbol) {
            // Just clean whitespace and convert to uppercase
            // Yahoo Finance handles dots in symbols correctly (e.g., BRK.A, BRK.B)
            return symbol.trim().toUpperCase();
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().match(/\.(csv|xlsx|xls|tsv)$/)) {
                addLogEntry('error', '‚ùå Please select a CSV, Excel, or TSV file');
                return;
            }

            addLogEntry('info', `üìÅ Loading file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result, file.name);
                } catch (error) {
                    addLogEntry('error', `‚ùå Error reading file: ${error.message}`);
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(csvContent, fileName) {
            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                const symbols = [];
                
                // Detect if first line is header
                const hasHeader = lines[0] && !lines[0].match(/^[A-Z]{1,5}(\.[A-Z])?$/);
                const startIndex = hasHeader ? 1 : 0;
                
                // Parse symbols
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        // Handle CSV with commas or just plain text
                        const parts = line.split(',');
                        const symbol = normalizeSymbol(parts[0]);
                        
                        if (symbol && symbol.length <= 10 && !symbols.includes(symbol)) {
                            symbols.push(symbol);
                        }
                    }
                }
                
                if (symbols.length === 0) {
                    addLogEntry('error', '‚ùå No valid stock symbols found in file');
                    return;
                }
                
                // Store stock data
                stockData = symbols.map(symbol => ({
                    symbol: symbol,
                    rawData: [symbol]
                }));
                
                updateFileInfo(fileName, symbols.length, 'CSV Import');
                updateRunButton();
                
                addLogEntry('success', `‚úÖ Loaded ${symbols.length} symbols from ${fileName}`);
                
            } catch (error) {
                addLogEntry('error', `‚ùå Error parsing CSV: ${error.message}`);
            }
        }

        function updateFileInfo(fileName, count, type) {
            const fileInfo = document.getElementById('fileInfo');
            const fileInfoTitle = document.getElementById('fileInfoTitle');
            const fileInfoDetails = document.getElementById('fileInfoDetails');
            
            fileInfoTitle.textContent = `üìã ${type}`;
            fileInfoDetails.textContent = `${fileName} ‚Ä¢ ${count} symbols`;
            fileInfo.classList.add('show');
        }

        function updateRunButton() {
            const runBtn = document.getElementById('startAnalysisBtn');
            const topRunBtn = document.getElementById('runAnalysisBtn');
            
            if (stockData && stockData.length > 0) {
                runBtn.disabled = false;
                runBtn.innerHTML = `<span>üöÄ</span> Analyze ${stockData.length} Stocks`;
                topRunBtn.disabled = false;
                topRunBtn.innerHTML = `üöÄ Analyze ${stockData.length} Stocks`;
            } else {
                runBtn.disabled = true;
                runBtn.innerHTML = '<span>üöÄ</span> Start Analysis';
                topRunBtn.disabled = true;
                topRunBtn.innerHTML = 'üöÄ Run Analysis';
            }
        }

        // Manual entry
        function showManualEntry() {
            const symbols = prompt('Enter stock symbols separated by commas:\n\nExample: AAPL, MSFT, GOOGL, AMZN, TSLA, BRK.A, BRK.B');
            
            if (symbols) {
                const symbolList = symbols.split(',').map(s => normalizeSymbol(s)).filter(s => s);
                
                if (symbolList.length > 0) {
                    stockData = symbolList.map(symbol => ({
                        symbol: symbol,
                        rawData: [symbol]
                    }));
                    
                    updateFileInfo('Manual Entry', symbolList.length, 'Manual Input');
                    updateRunButton();
                    
                    addLogEntry('success', `‚úÖ Added ${symbolList.length} symbols manually`);
                } else {
                    addLogEntry('error', '‚ùå No valid symbols entered');
                }
            }
        }

        function clearData() {
            stockData = [];
            analysisResults = [];
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.classList.remove('show');
            
            const resultsTable = document.getElementById('resultsTable');
            resultsTable.style.display = 'none';
            
            updateRunButton();
            updateStats();
            
            addLogEntry('info', 'üóëÔ∏è Data cleared');
        }

        // Load sample data  
        async function loadSampleData() {
            console.log('üß™ Loading sample data...');
            
            try {
                console.log('üîç Attempting to load sample data from backend...');
                const response = await fetch(`${API_BASE_URL}/sample-data`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Sample data received:', data);
                    
                    if (data.symbols && data.symbols.length > 0) {
                        stockData = data.symbols.map(symbol => ({
                            symbol: normalizeSymbol(symbol),
                            rawData: [symbol]
                        }));
                        
                        updateFileInfo('Backend Sample Data', stockData.length, 'Sample Data');
                        updateRunButton();
                        
                        addLogEntry('success', `üß™ Loaded ${stockData.length} sample stocks from backend`);
                        console.log('‚úÖ Backend sample data loaded successfully');
                        return;
                    }
                }
                
                console.log('‚ö†Ô∏è Backend sample data failed, using local fallback');
                
            } catch (error) {
                console.log('‚ö†Ô∏è Backend sample data failed, using local fallback');
            }
            
            // Fallback to local sample data
            console.log('üìä Loading local sample data...');
            const sampleSymbols = [
                'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA',
                'NFLX', 'CRM', 'ADBE', 'AMD', 'QCOM', 'AVGO', 'ORCL', 'UBER', 'DIS',
                'JPM', 'WMT'
            ];
            
            stockData = sampleSymbols.map(symbol => ({
                symbol: normalizeSymbol(symbol),
                rawData: [symbol]
            }));
            
            console.log('Sample stockData created:', stockData);
            
            updateFileInfo('Local Sample Data', stockData.length, 'Test Symbols');
            updateRunButton();
            
            addLogEntry('success', `üß™ Loaded ${stockData.length} sample stocks for testing (including BRK.A/BRK.B)`);
            console.log('‚úÖ Sample data loaded successfully');
        }

        // Backend communication
        async function testBackendConnection() {
            try {
                addLogEntry('info', 'üîÑ Testing backend connection...');
                
                const response = await fetch(`${API_BASE_URL}/health`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                addLogEntry('success', '‚úÖ Backend connection successful!');
                addLogEntry('info', `‚ö° Max workers: ${data.system_status?.max_workers || 'Unknown'}`);
                
                // Update live indicator
                const liveIndicator = document.getElementById('liveIndicator');
                liveIndicator.style.background = '#238636';
                
                return true;
            } catch (error) {
                addLogEntry('error', '‚ùå Backend connection failed!');
                addLogEntry('error', 'üìã Please start the backend: python app.py');
                
                // Update live indicator
                const liveIndicator = document.getElementById('liveIndicator');
                liveIndicator.style.background = '#f85149';
                liveIndicator.textContent = '‚óè OFFLINE';
                
                return false;
            }
        }

        // Enhanced analysis with auto-batching and better error handling
        async function startAnalysis() {
            if (isAnalyzing) {
                addLogEntry('warning', '‚ö†Ô∏è Analysis already in progress...');
                return;
            }
            
            if (!stockData || stockData.length === 0) {
                addLogEntry('error', '‚ùå No stock data loaded. Please import a file or load sample data.');
                return;
            }
            
            try {
                isAnalyzing = true;
                analysisResults = []; // Clear previous results
                updateAnalysisUI(true);
                
                const allSymbols = stockData.map(item => item.symbol);
                addLogEntry('info', `üéØ Starting analysis for ${allSymbols.length} symbols`);
                
                console.log('üéØ Starting analysis for symbols:', allSymbols);
                
                // For now, we'll use single batch since our backend handles it
                if (allSymbols.length <= MAX_SYMBOLS_PER_BATCH) {
                    console.log('üì¶ Processing as single batch...');
                    addLogEntry('info', `üì¶ Processing ${allSymbols.length} symbols as single batch...`);
                    
                    const batchResults = await processSingleBatch(allSymbols);
                    console.log('üì¶ Single batch results:', batchResults);
                    
                    if (batchResults && batchResults.length > 0) {
                        analysisResults = batchResults;
                        console.log('üìä Final analysisResults Count:', analysisResults.length);
                    } else {
                        console.error('‚ùå Single batch failed or returned invalid results');
                        addLogEntry('error', '‚ùå Analysis failed - no valid results received');
                    }
                }
                
                console.log('üìä Final analysisResults before display:', {
                    count: analysisResults.length,
                    sample: analysisResults[0]
                });
                
                // Check if we have any results
                if (!analysisResults || analysisResults.length === 0) {
                    throw new Error('No analysis results received from backend');
                }
                
                addLogEntry('success', `‚úÖ Analysis complete! ${analysisResults.length} stocks processed`);
                
                console.log('Calling displayResults...');
                displayResults();
                
                console.log('Calling updateStats...');
                updateStats();
                
            } catch (error) {
                console.error('Analysis error:', error);
                addLogEntry('error', `‚ùå Analysis failed: ${error.message}`);
            } finally {
                isAnalyzing = false;
                updateAnalysisUI(false);
            }
        }

        async function processSingleBatch(symbols) {
            try {
                addLogEntry('info', `üì° Sending request for ${symbols.length} symbols...`);
                console.log('Sending analysis request for symbols:', symbols);
                
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: symbols })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                console.log('Data.results:', data.results);
                console.log('Data.results type:', typeof data.results);
                console.log('Data.results length:', data.results ? data.results.length : 'undefined');
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Validate that we have results
                if (!data.results || !Array.isArray(data.results)) {
                    console.error('‚ùå Invalid results format:', data);
                    addLogEntry('error', '‚ùå Backend returned invalid results format');
                    return [];
                }

                console.log('‚úÖ Valid results received, count:', data.results.length);
                return data.results;
                
            } catch (error) {
                console.error('Batch processing error:', error);
                addLogEntry('error', `‚ùå Batch processing failed: ${error.message}`);
                return [];
            }
        }

        async function stopAnalysis() {
            try {
                addLogEntry('warning', '‚èπÔ∏è Stopping analysis...');
                
                await fetch(`${API_BASE_URL}/stop-analysis`, { method: 'POST' });
                
                isAnalyzing = false;
                updateAnalysisUI(false);
                
                addLogEntry('warning', '‚èπÔ∏è Analysis stopped by user');
                
            } catch (error) {
                addLogEntry('error', `‚ùå Error stopping analysis: ${error.message}`);
            }
        }

        function updateAnalysisUI(analyzing) {
            const startBtn = document.getElementById('startAnalysisBtn');
            const stopBtn = document.getElementById('stopAnalysisBtn');
            const topRunBtn = document.getElementById('runAnalysisBtn');
            
            if (analyzing) {
                startBtn.innerHTML = '<span>‚èπÔ∏è</span> Stop Analysis';
                startBtn.onclick = stopAnalysis;
                if (topRunBtn) {
                    topRunBtn.innerHTML = '‚èπÔ∏è Stop';
                    topRunBtn.onclick = stopAnalysis;
                }
            } else {
                startBtn.innerHTML = `<span>üöÄ</span> ${stockData.length > 0 ? `Analyze ${stockData.length} Stocks` : 'Start Analysis'}`;
                startBtn.onclick = startAnalysis;
                if (topRunBtn) {
                    topRunBtn.innerHTML = stockData.length > 0 ? `üöÄ Analyze ${stockData.length}` : 'üöÄ Run Analysis';
                    topRunBtn.onclick = startAnalysis;
                }
            }
        }

        // Results display with enhanced columns and debugging  
        function displayResults() {
            console.log('üéØ displayResults() called');
            
            const tableBody = document.getElementById('resultsTableBody');
            const resultsTable = document.getElementById('resultsTable');
            const filterBar = document.getElementById('filterBar');
            const tableTitle = document.getElementById('tableTitle');
            
            console.log('Elements found:', {
                tableBody: !!tableBody,
                resultsTable: !!resultsTable,
                filterBar: !!filterBar,
                tableTitle: !!tableTitle
            });
            
            console.log('Analysis results:', {
                exists: !!analysisResults,
                length: analysisResults ? analysisResults.length : 'undefined'
            });
            
            if (!tableBody || !resultsTable) {
                console.error('‚ùå Critical elements not found!');
                addLogEntry('error', '‚ùå Table elements not found in DOM');
                return;
            }
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            if (!analysisResults || analysisResults.length === 0) {
                console.log('‚ùå No results to display');
                addLogEntry('warning', '‚ö†Ô∏è No analysis results to display');
                return;
            }
            
            console.log('‚úÖ Proceeding to display', analysisResults.length, 'results');
            
            // Sort by RS rating by default (high to low)
            analysisResults.sort((a, b) => (b.rs_rating || 0) - (a.rs_rating || 0));
            console.log('‚úÖ Results sorted by RS rating (high to low)');
            
            // Show table and filter bar
            console.log('Setting table display to block...');
            resultsTable.style.display = 'block';
            resultsTable.classList.add('show');  // Force show with CSS class
            
            if (filterBar) {
                console.log('Setting filter bar display to flex...');
                filterBar.style.display = 'flex';
            }
            
            const passedCount = analysisResults.filter(r => r.passed && !r.error).length;
            const titleText = `Analysis Results (${analysisResults.length} stocks, ${passedCount} passed)`;
            
            if (tableTitle) {
                console.log('Setting table title:', titleText);
                tableTitle.textContent = titleText;
            }
            
            console.log('Creating rows for', analysisResults.length, 'results');
            
            // Create rows
            let successCount = 0;
            let errorCount = 0;
            
            analysisResults.forEach((result, index) => {
                try {
                    console.log(`Creating row ${index + 1}/${analysisResults.length} for:`, result.symbol);
                    const row = createResultRow(result);
                    tableBody.appendChild(row);
                    successCount++;
                } catch (error) {
                    console.error(`‚ùå Error creating row ${index + 1} for result:`, result, 'Error:', error);
                    errorCount++;
                    
                    // Create fallback row
                    const fallbackRow = document.createElement('tr');
                    fallbackRow.innerHTML = `
                        <td>${result.symbol || 'Unknown'}</td>
                        <td colspan="13">Error creating row: ${error.message}</td>
                    `;
                    tableBody.appendChild(fallbackRow);
                }
            });
            
            console.log(`üìä Row creation summary: ${successCount} success, ${errorCount} errors`);
            
            const finalRowCount = tableBody.children.length;
            console.log('üìä Final table body children count:', finalRowCount);
            
            if (finalRowCount === 0) {
                console.error('‚ùå No rows were added to table body!');
                addLogEntry('error', '‚ùå Failed to create any table rows');
            } else {
                console.log('‚úÖ displayResults completed successfully');
                addLogEntry('success', `‚úÖ Table displayed with ${finalRowCount} rows`);
            }
        }

        function createResultRow(result) {
            const row = document.createElement('tr');
            row.className = result.passed ? 'passed' : 'failed';
            
            if (result.error) {
                row.innerHTML = `
                    <td class="symbol-cell">${result.symbol}</td>
                    <td class="status-cell"><span class="status-indicator status-fail">ERROR</span></td>
                    <td colspan="12" class="negative">Error: ${result.error}</td>
                `;
            } else {
                const isWatched = watchList.some(w => w.symbol === result.symbol);
                const watchClass = isWatched ? 'watched' : '';
                
                // Get values with proper formatting
                const ma50 = result.metrics.ma50 ? `${result.metrics.ma50}` : 'N/A';
                const ma150 = result.metrics.ma150 ? `${result.metrics.ma150}` : 'N/A';
                const ma200 = result.metrics.ma200 ? `${result.metrics.ma200}` : 'N/A';
                const week52Low = result.metrics.week_52_low ? `${result.metrics.week_52_low}` : 'N/A';
                const week52High = result.metrics.week_52_high ? `${result.metrics.week_52_high}` : 'N/A';
                
                // Format fail reasons - show "All criteria passed ‚úÖ" if passed
                const failReason = result.passed 
                    ? '<span class="positive"><strong>All criteria passed ‚úÖ</strong></span>'
                    : `<span class="negative">${result.fail_reasons.join(', ')}</span>`;
                
                row.innerHTML = `
                    <td class="symbol-cell">${result.symbol}</td>
                    <td class="status-cell">
                        <span class="status-indicator ${result.passed ? 'status-pass' : 'status-fail'}">
                            ${result.passed ? 'PASS' : 'FAIL'}
                        </span>
                    </td>
                    <td class="metric-cell neutral">${result.metrics.price}</td>
                    <td class="metric-cell neutral">${ma50}</td>
                    <td class="metric-cell neutral">${ma150}</td>
                    <td class="metric-cell neutral">${ma200}</td>
                    <td class="metric-cell neutral">${week52Low}</td>
                    <td class="metric-cell neutral">${week52High}</td>
                    <td class="metric-cell ${result.metrics.from_low_pct >= 30 ? 'positive' : 'negative'}">
                        ${result.metrics.from_low_pct}%
                    </td>
                    <td class="metric-cell ${result.metrics.from_high_pct <= 25 ? 'positive' : 'negative'}">
                        ${result.metrics.from_high_pct}%
                    </td>
                    <td class="metric-cell">${result.rs_rating}</td>
                    <td class="metric-cell ${result.metrics.ma200_trending_up ? 'positive' : 'negative'}">
                        ${result.metrics.ma200_trending_up ? 'UP ‚Üó' : 'DOWN ‚Üò'}
                    </td>
                    <td class="metric-cell" style="max-width: 300px; white-space: normal; word-wrap: break-word;">
                        ${failReason}
                    </td>
                    <td>
                        <button class="watch-toggle ${watchClass}" onclick="toggleWatch('${result.symbol}')">
                            ‚≠ê
                        </button>
                    </td>
                `;
            }
            
            return row;
        }

        function formatVolume(volume) {
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            } else {
                return volume.toString();
            }
        }

        // TEMPORARY DEBUG FUNCTION
        function forceDisplayResults() {
            console.log('üîß Force displaying results...');
            
            if (!analysisResults || analysisResults.length === 0) {
                console.log('‚ùå No results to display');
                addLogEntry('warning', '‚ö†Ô∏è No analysis results available for force display');
                return;
            }
            
            const tableBody = document.getElementById('resultsTableBody');
            const resultsTable = document.getElementById('resultsTable');
            
            if (!tableBody || !resultsTable) {
                console.log('‚ùå Table elements not found');
                addLogEntry('error', '‚ùå Required table elements not found in DOM');
                return;
            }
            
            // Force show table
            resultsTable.style.display = 'block';
            resultsTable.style.visibility = 'visible';
            resultsTable.classList.add('show');
            
            // Clear and rebuild
            tableBody.innerHTML = '';
            
            console.log('üîß Building simplified table with', analysisResults.length, 'results');
            
            analysisResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = result.passed ? 'passed' : 'failed';
                
                row.innerHTML = `
                    <td class="symbol-cell">${result.symbol}</td>
                    <td class="status-cell">
                        <span class="status-indicator ${result.passed ? 'status-pass' : 'status-fail'}">
                            ${result.passed ? 'PASS' : 'FAIL'}
                        </span>
                    </td>
                    <td>${result.rs_rating}</td>
                    <td>${result.metrics?.price || 'N/A'}</td>
                    <td colspan="10">${result.fail_reasons?.join(', ') || 'All passed'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update table title
            const tableTitle = document.getElementById('tableTitle');
            if (tableTitle) {
                const passedCount = analysisResults.filter(r => r.passed).length;
                tableTitle.textContent = `Analysis Results (${analysisResults.length} stocks, ${passedCount} passed) - FORCE DISPLAYED`;
            }
            
            console.log('‚úÖ Table forced to display with', tableBody.children.length, 'rows');
            addLogEntry('success', `üîß Force displayed ${tableBody.children.length} results`);
        }

        // Stats and UI updates
        function updateStats() {
            const totalElement = document.getElementById('statTotal');
            const passedElement = document.getElementById('statPassed');
            const rateElement = document.getElementById('statRate');
            
            if (!analysisResults || analysisResults.length === 0) {
                totalElement.textContent = '0';
                passedElement.textContent = '0';
                rateElement.textContent = '0%';
                return;
            }
            
            const total = analysisResults.length;
            const passed = analysisResults.filter(r => r.passed && !r.error).length;
            const rate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            totalElement.textContent = total;
            passedElement.textContent = passed;
            rateElement.textContent = `${rate}%`;
            
            // Update change indicators
            document.getElementById('statTotalChange').textContent = `${total} stocks analyzed`;
            document.getElementById('statPassedChange').textContent = `${passed} met criteria`;
            document.getElementById('statRateChange').textContent = `${rate}% success rate`;
        }

        function updateUI() {
            updateRunButton();
            updateStats();
            updateWatchListCount();
        }

        // Watch list functionality
        function loadWatchListFromStorage() {
            try {
                const stored = localStorage.getItem('stockHunter_watchList');
                watchList = stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error loading watch list:', error);
                watchList = [];
            }
        }

        function saveWatchListToStorage() {
            try {
                localStorage.setItem('stockHunter_watchList', JSON.stringify(watchList));
            } catch (error) {
                console.error('Error saving watch list:', error);
            }
        }

        function toggleWatch(symbol) {
            const existingIndex = watchList.findIndex(item => item.symbol === symbol);
            
            if (existingIndex !== -1) {
                watchList.splice(existingIndex, 1);
                addLogEntry('info', `üìã Removed ${symbol} from watch list`);
            } else {
                const result = analysisResults.find(r => r.symbol === symbol);
                watchList.push({
                    symbol: symbol,
                    added: new Date().toISOString(),
                    passed: result ? result.passed : false,
                    rs_rating: result ? result.rs_rating : 0
                });
                addLogEntry('success', `‚≠ê Added ${symbol} to watch list`);
            }
            
            saveWatchListToStorage();
            updateWatchListCount();
            
            // Refresh display to update watch buttons
            if (analysisResults.length > 0) {
                displayResults();
            }
        }

        function updateWatchListCount() {
            const countElement = document.getElementById('watchListCount');
            const statWatched = document.getElementById('statWatched');
            
            if (countElement) countElement.textContent = watchList.length;
            if (statWatched) statWatched.textContent = watchList.length;
        }

        function addAllPassedToWatch() {
            if (!analysisResults || analysisResults.length === 0) {
                addLogEntry('warning', '‚ö†Ô∏è No analysis results available');
                return;
            }
            
            const passedResults = analysisResults.filter(r => r.passed && !r.error);
            let addedCount = 0;
            
            passedResults.forEach(result => {
                const existingIndex = watchList.findIndex(item => item.symbol === result.symbol);
                if (existingIndex === -1) {
                    watchList.push({
                        symbol: result.symbol,
                        added: new Date().toISOString(),
                        passed: true,
                        rs_rating: result.rs_rating || 0
                    });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                saveWatchListToStorage();
                updateWatchListCount();
                displayResults(); // Refresh to show watch status
                
                addLogEntry('success', `‚≠ê Added ${addedCount} passed stocks to watch list`);
                
                // Show notification
                showAutoAddNotification(addedCount);
            } else {
                addLogEntry('info', 'üìã All passed stocks are already in watch list');
            }
        }

        function showAutoAddNotification(count) {
            // This would show a nice notification - for now just log
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: #238636; color: white; 
                padding: 12px 16px; border-radius: 6px; 
                z-index: 1000; font-weight: 600;
            `;
            notification.innerHTML = `‚≠ê Added <span id="autoAddCount">${count}</span> stocks to watch list`;
            document.body.appendChild(notification);
            
            const countSpan = document.getElementById('autoAddCount');
            
            countSpan.textContent = count;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Export functionality
        function exportResults() {
            if (!analysisResults || analysisResults.length === 0) {
                addLogEntry('warning', '‚ö†Ô∏è No results to export');
                return;
            }
            
            let csvContent = 'Symbol,Status,RS Rating,Price,50MA,150MA,200MA,52W Low,52W High,From Low %,From High %,200MA Trend,Fail Reasons\n';
            
            analysisResults.forEach(result => {
                const row = [
                    result.symbol,
                    result.passed ? 'PASS' : 'FAIL',
                    result.rs_rating || 0,
                    result.metrics?.price || '',
                    result.metrics?.ma50 || '',
                    result.metrics?.ma150 || '',
                    result.metrics?.ma200 || '',
                    result.metrics?.week_52_low || '',
                    result.metrics?.week_52_high || '',
                    result.metrics?.from_low_pct || '',
                    result.metrics?.from_high_pct || '',
                    result.metrics?.ma200_trending_up ? 'UP' : 'DOWN',
                    result.fail_reasons ? `"${result.fail_reasons.join('; ')}"` : ''
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock_analysis_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            addLogEntry('success', `üíæ Exported ${analysisResults.length} results to CSV`);
        }

        // Filtering functionality
        function applyFilters() {
            // Implementation for filtering results
            addLogEntry('info', 'üîç Applying filters...');
        }

        // Logging functionality
        function addLogEntry(type, message) {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            const typeLabel = type.toUpperCase();
            
            entry.innerHTML = `
                <span class="log-timestamp">[${typeLabel}]</span>
                <span class="${typeClass}">${message}</span>
            `;
            
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Keep only last 100 entries
            while (logPanel.children.length > 100) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }

        function clearLog() {
            const logPanel = document.getElementById('logPanel');
            logPanel.innerHTML = '';
            addLogEntry('info', 'üóëÔ∏è Log cleared');
        }

        // Utility functions
        function importCSV() {
            document.getElementById('uploadArea').click();
        }

        function addDebugButton() {
            // Debug functionality already added via header buttons
        }

        // Load sample data on startup for demo
        function loadSampleDataOnStartup() {
            const sampleSymbols = [
                "AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "META", "NVDA",
                "NFLX", "CRM", "ADBE", "AMD", "QCOM", "AVGO", "ORCL", "UBER", "DIS",
                "JPM", "WMT"
            ];

            stockData = sampleSymbols.map(symbol => ({
                symbol: normalizeSymbol(symbol),
                rawData: [symbol]
            }));

            updateFileInfo("Sample Data", stockData.length, "Test Symbols");
            updateRunButton();
            addLogEntry('success', `‚úÖ Loaded ${stockData.length} sample stocks for testing`);
        }

        window.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('loadSampleBtn');
            if (btn) {
                btn.addEventListener('click', loadSampleData);
            }
        });
    </script>
</body>
</html>